# Актуальное руководство по миграции данных с Drupal 6

> **Цель:** Быстро развернуть проект с нуля, используя данные из оригинального дампа Drupal 6,
> с помощью современной архитектуры на основе автоматических миграций **Flyway**.

---

## Концепция

В отличие от старого, полностью ручного процесса, этот метод использует автоматизацию. Данные из старого
дампа Drupal 6 больше не импортируются в базу данных напрямую. Вместо этого, они были преобразованы
в специальный миграционный скрипт Flyway (`V3__insert_sample_data.sql`), который является частью
исходного кода проекта.

Это гарантирует, что любой разработчик, запустивший проект с нуля, получит идентичную базу данных
с уже включенными в нее историческими данными, без ручных манипуляций с SQL-дампами.

---

## Процесс развертывания с нуля

Для нового разработчика, которому нужно поднять проект локально с полной базой данных, процесс
теперь выглядит предельно просто.

### Шаг 1: Подготовка окружения

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <URL вашего репозитория>
    cd phoebe
    ```

2.  **Убедитесь, что Docker и Docker Compose установлены и запущены.**

### Шаг 2: Запуск проекта

Выполните одну команду, которая запустит и базу данных, и приложение:

```bash
docker compose up --build
```

### Что произойдет автоматически?

1.  **Сборка и запуск контейнеров:** `docker-compose` соберет образ вашего Spring Boot приложения и запустит
    два контейнера: `phoebe-app` (приложение) и `phoebe-mysql` (база данных MySQL 8.0).

2.  **Создание пустой базы:** При первом запуске контейнер `phoebe-mysql` создаст пустую базу данных с именем `phoebe_db`.

3.  **Автоматические миграции Flyway (версия 9.22.3):**
    - Ваше Spring Boot приложение (`phoebe-app`) стартует и подключится к пустой базе.
    - **Flyway**, встроенный в приложение, обнаружит, что база пуста.
    - Flyway последовательно выполнит все SQL-скрипты из папок миграций:
      - `V1__initial_schema.sql`: Создаст всю структуру таблиц (`users`, `content` и т.д.).
      - `V3__insert_sample_data.sql`: **Заполнит эти таблицы данными**, включая пользователей, роли и контент.
      - `V4-V7`: Применят изменения схемы (унификация авторов, система разрешений, настройки канала).
      - `V8-V9`: Настроят разрешения и добавят индексы производительности.
      - `V10`: Добавит поле `site_url` в настройки канала для хранения базового URL сайта.
      - `V12`: Добавляет таблицы для функциональности блоков главной страницы.
      - `V13`: Делает столбцы `created_at` и `updated_at` в таблице `content` ненулевыми.

### Шаг 3: Проверка результата

После того как все контейнеры успешно запустятся, ваша база данных будет полностью готова и наполнена данными.

Вы можете проверить это, подключившись к базе данных:

```bash
# Подключиться к контейнеру с базой данных
docker exec -it phoebe-mysql mysql -uroot -proot

# Внутри MySQL выполнить команды
USE phoebe_db;
SELECT COUNT(*) FROM content; -- Должно показать тестовые записи
SELECT COUNT(*) FROM users;   -- Должно показать пользователей
SELECT COUNT(*) FROM permissions; -- Должно показать настроенные разрешения
SELECT site_url FROM channel_settings; -- Должно показать базовый URL сайта
```

## Заключение

Этот автоматизированный подход устраняет необходимость в ручном импорте SQL-дампов, гарантирует консистентность
базы данных у всех разработчиков и является стандартной практикой в современных проектах.

Старое руководство по миграции (`MIGRATION_DRUPAL6_RU.md`) сохранено в архиве для понимания того, как
именно данные из `drupal6_working.sql` были однажды преобразованы в миграционный скрипт Flyway.
