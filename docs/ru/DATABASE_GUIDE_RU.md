> [Вернуться к содержанию документации](./README.md) | [Руководство по MySQL](./MYSQL_GUIDE_RU.md)

# Руководство по базе данных – Phoebe CMS

Это комплексное руководство охватывает схему базы данных, настройку, миграцию и устранение неполадок 
для Phoebe CMS. Схема поддерживает как **чистые установки**, так и **мигрированные данные из Drupal 6**.

## Содержание
- [Схема базы данных](#схема-базы-данных)
- [Быстрая настройка](#быстрая-настройка)
- [Восстановление/исследование данных из произвольного Docker Volume MySQL](#восстановлениеисследование-данных-из-произвольного-docker-volume-mysql)
- [Миграция из Drupal 6 (Исторический/Ручной процесс)](#миграция-из-drupal-6-историческийручной-процесс)
- [Справочник скриптов миграции](#справочник-скриптов-миграции)
- [Миграции Spring Boot](#миграции-spring-boot)
- [Аутентификация и контроль доступа](#аутентификация-и-контроль-доступа)
- [Взаимодействие с базами данных](#взаимодействие-с-базами-данными)
- [Рекомендации по работе с продакшен-базами данных](#рекомендации-по-работе-с-продакшен-базами-данных)
- [Устранение неполадок](#устранение-неполадок)
- [Связанная документация](#связанная-документация)

---

## Схема базы данных

### Возможности схемы

- **Управление пользователями**: Аутентификация с ролевым контролем доступа
- **Система разрешений**: Детализированные разрешения, назначаемые ролям
- **Управление контентом**: Единое хранилище для новостных статей и контента
- **Система таксономии**: Категории и теги с гибкими словарями
- **Рабочий процесс публикации**: Состояния черновик/опубликовано с аудитом
- **Поддержка миграции**: Обработка трансформации данных из Drupal 6

### Текущая схема базы данных `phoebe_db` (После всех миграций V1-V10)

```sql
-- ======================================
-- ТАБЛИЦА ПОЛЬЗОВАТЕЛЕЙ
-- ======================================
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,              -- BCrypt хешированные пароли
    email VARCHAR(255) UNIQUE,
    active BOOLEAN NOT NULL DEFAULT TRUE         -- true = активен, false = заблокирован
);

-- ======================================
-- ТАБЛИЦА РОЛЕЙ
-- ======================================
CREATE TABLE roles (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,            -- 'ADMIN', 'EDITOR', и т.д.
    description VARCHAR(255)                     -- Описание роли (добавлено в V5)
);

-- ======================================
-- ТАБЛИЦА РАЗРЕШЕНИЙ (Добавлена в V5)
-- ======================================
CREATE TABLE permissions (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE            -- 'news:read', 'users:create', и т.д.
);

-- ======================================
-- USER_ROLES (Многие-ко-многим)
-- ======================================
CREATE TABLE user_roles (
    user_id BIGINT NOT NULL,
    role_id BIGINT NOT NULL,
    PRIMARY KEY (user_id, role_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE
);

-- ======================================
-- ROLE_PERMISSIONS (Многие-ко-многим, Добавлена в V5)
-- ======================================
CREATE TABLE role_permissions (
    role_id BIGINT NOT NULL,
    permission_id BIGINT NOT NULL,
    PRIMARY KEY (role_id, permission_id),
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE
);

-- ======================================
-- ТАБЛИЦА КОНТЕНТА (Новостные статьи)
-- ======================================
CREATE TABLE content (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    body TEXT,                                   -- Полный текст статьи
    teaser TEXT,                                 -- Краткое описание/анонс
    publication_date DATETIME NOT NULL,
    published BOOLEAN NOT NULL DEFAULT FALSE,    -- Добавлено в V2: черновик/опубликовано
    created_at DATETIME,                         -- Аудит: время создания
    updated_at DATETIME,                         -- Аудит: последнее изменение
    version BIGINT,                              -- Оптимистичная блокировка
    author_id BIGINT NOT NULL,                   -- FK на users.id
    FOREIGN KEY (author_id) REFERENCES users(id)
);

-- ======================================
-- ТАБЛИЦА ТЕРМИНОВ (Таксономия)
-- ======================================
CREATE TABLE terms (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    vocabulary VARCHAR(100),                     -- 'category', 'tag', и т.д.
    UNIQUE (name, vocabulary)
);

-- ======================================
-- CONTENT_TERMS (Многие-ко-многим)
-- ======================================
CREATE TABLE content_terms (
    content_id BIGINT NOT NULL,
    term_id BIGINT NOT NULL,
    PRIMARY KEY (content_id, term_id),
    FOREIGN KEY (content_id) REFERENCES content(id) ON DELETE CASCADE,
    FOREIGN KEY (term_id) REFERENCES terms(id) ON DELETE CASCADE
);
```

### Примеры запросов

```sql
-- Список всех опубликованных статей с авторами
SELECT c.title, c.publication_date, u.username as author
FROM content c
JOIN users u ON c.author_id = u.id
WHERE c.published = TRUE
ORDER BY c.publication_date DESC;

-- Получение разрешений пользователя через роли
SELECT u.username, p.name as permission
FROM users u
JOIN user_roles ur ON u.id = ur.user_id
JOIN roles r ON ur.role_id = r.id
JOIN role_permissions rp ON r.id = rp.role_id
JOIN permissions p ON rp.permission_id = p.id
WHERE u.active = TRUE;

-- Поиск статей по термину
SELECT c.title, t.name as term
FROM content c
JOIN content_terms ct ON c.id = ct.content_id
JOIN terms t ON ct.term_id = t.id
WHERE t.name = 'Технологии';
```

---

## Быстрая настройка

### Новая установка (Чистая база данных)
Самый простой способ запустить проект для локальной разработки — использовать Makefile.
```bash
# Запустить весь проект (БД + Бэкенд)
make run
```
При первом запуске Flyway автоматически применит все необходимые миграции. Учетные данные по умолчанию: `admin` / `admin`.

### Для запуска тестов
**Никакой ручной настройки базы данных не требуется.** Интеграционные тесты полностью автоматизированы с помощью Testcontainers.
```bash
# Запустить только интеграционные тесты
make test
```

### Ручное создание пользователя администратора
Если вам нужно создать пользователя администратора вручную (например, если вы отключили миграцию V3 с тестовыми данными или для отладки), вы можете использовать скрипт:
```bash
mysql phoebe_db < db_data/create_admin_user.sql
```
*   **Примечание**: Этот скрипт создает пользователя `admin` с паролем `admin`. Он предназначен **только для разработки** и не должен использоваться в продакшене.

---

## Восстановление/исследование данных из произвольного Docker Volume MySQL

Этот раздел описывает, как получить доступ к данным из существующего Docker Volume MySQL, который не обязательно является частью текущего проекта `docker-compose`. Это полезно для "спасения" данных, исследования содержимого старых вольюмов или когда вы не знаете пароль `root` или имя базы данных.

### Шаг 1: Запуск временного контейнера MySQL с монтированием Volume

Откройте **первое окно терминала** и выполните следующую команду. Она запустит временный контейнер MySQL 5.7, который смонтирует ваш целевой Docker Volume.

```bash
docker run -it --rm --name temp_mysql_explorer \
  -v <ИМЯ_ВАШЕГО_VOLUME>:/var/lib/mysql \
  -e MYSQL_ALLOW_EMPTY_PASSWORD=yes \
  -e MYSQL_ROOT_PASSWORD= \
  mysql:5.7
```

*   Замените `<ИМЯ_ВАШЕГО_VOLUME>` на реальное имя Docker Volume, который вы хотите исследовать (например, `news-platform_mysql_data_drupal6`).
*   `--name temp_mysql_explorer`: Присваивает контейнеру временное имя для удобства.
*   `-v <ИМЯ_ВАШЕГО_VOLUME>:/var/lib/mysql`: Монтирует ваш Docker Volume в стандартное место хранения данных MySQL внутри контейнера.
*   `-e MYSQL_ALLOW_EMPTY_PASSWORD=yes -e MYSQL_ROOT_PASSWORD=`: Запускает MySQL с пустым паролем для пользователя `root`. Это позволяет гарантированно получить доступ к данным, даже если вы не знаете старый пароль Volume.
*   **Оставьте этот терминал открытым!** Контейнер будет работать, пока вы его не закроете.

### Шаг 2: Интерактивное исследование баз данных

Откройте **второе окно терминала** и подключитесь к запущенному контейнеру MySQL:

```bash
docker exec -it temp_mysql_explorer mysql -uroot
```

*   Поскольку мы запустили контейнер с пустым паролем `root`, вам не нужно указывать `-p`.

Внутри MySQL-клиента вы можете:

1.  **Посмотреть список всех баз данных:**
    ```sql
    SHOW DATABASES;
    ```
    Найдите базы данных, которые могут содержать нужные вам данные (например, `dniester`, `a264971_dniester`, `drupal` и т.д.).

2.  **Выбрать базу данных для исследования:**
    ```sql
    USE <ИМЯ_НАЙДЕННОЙ_БАЗЫ_ДАННЫХ>;
    ```
    Замените `<ИМЯ_НАЙДЕННОЙ_БАЗЫ_ДАННЫХ>` на имя, которое вы нашли.

3.  **Посмотреть таблицы в выбранной базе:**
    ```sql
    SHOW TABLES;
    ```

4.  **Посмотреть количество записей в таблице (например, `node` или `content`):**
    ```sql
    SELECT COUNT(*) FROM <ИМЯ_ТАБЛИЦЫ>;
    ```
    Это поможет вам убедиться, что база данных содержит данные.

5.  **Выйти из MySQL-клиента:**
    ```sql
    exit
    ```

### Шаг 3: Создание дампа нужных баз данных

После того как вы определили имена баз данных, которые хотите сохранить, откройте **третье окно терминала** и выполните команды `mysqldump`.

1.  **Дамп первой базы данных:**
    ```bash
    docker exec temp_mysql_explorer mysqldump -uroot <ИМЯ_ПЕРВОЙ_БАЗЫ_ДАННЫХ> \
      --single-transaction --quick --routines > <ИМЯ_ПЕРВОЙ_БАЗЫ_ДАННЫХ>_dump.sql
    ```
    *   Замените `<ИМЯ_ПЕРВОЙ_БАЗЫ_ДАННЫХ>` на реальное имя базы (например, `dniester`).
    *   Файл дампа будет создан в текущей директории на вашей хост-машине.

2.  **Дамп второй базы данных (если нужно):**
    ```bash
    docker exec temp_mysql_explorer mysqldump -uroot <ИМЯ_ВТОРОЙ_БАЗЫ_ДАННЫХ> \
      --single-transaction --quick --routines > <ИМЯ_ВТОРОЙ_БАЗЫ_ДАННЫХ>_dump.sql
    ```
    *   Замените `<ИМЯ_ВТОРОЙ_БАЗЫ_ДАННЫХ>` на реальное имя базы (например, `a264971_dniester`).

### Шаг 4: Остановка временного контейнера

После того как вы получили все необходимые дампы, просто закройте **первое окно терминала**, в котором был запущен `docker run ...`. Контейнер автоматически удалится благодаря флагу `--rm`.

---

## Миграция из Drupal 6 (Исторический/Ручной процесс)

> **Важно**: Этот раздел описывает *исторический и ручной процесс* миграции данных из Drupal 6.
> **Для актуального и автоматизированного развертывания проекта с данными из Drupal 6, пожалуйста, обратитесь к [Актуальному руководству по миграции данных с Drupal 6](./MODERN_MIGRATION_GUIDE_RU.md).**
> Этот ручной процесс может быть полезен для отладки или понимания того, как данные были преобразованы.

### Рабочий процесс миграции

1.  **Фаза анализа**
    ```sql
    mysql drupal6_db < db_data/detect_custom_fields.sql
    ```

2.  **Основная миграция**
    ```sql
    mysql clean_db < db_data/migrate_from_drupal6_universal.sql
    ```

3.  **Миграция пользовательских полей**
    ```sql
    mysql clean_db < db_data/migrate_cck_fields.sql
    ```

4.  **Очистка пользовательских данных**
    ```sql
    mysql clean_db < db_data/update_migrated_users.sql
    ```

### Учетные данные после миграции

После миграции пользователи будут иметь:
- **Администратор**: имя пользователя `admin`, пароль `admin`
- **Мигрированные пользователи**: их исходное имя пользователя, пароль `changeme123`
- **Все мигрированные пользователи должны сбросить пароли при первом входе**

### Архивные данные и система словарей

**Важно:** Все архивные термины из Drupal 6 полностью сохраняются с их классификациями vocabulary.

**Миграция обеспечивает:**
- Целостность архива: Все существующие связи новости-термин сохраняются
- Сохранение vocabulary: Исходные имена vocabulary Drupal 6 ("category", "tags", и т.д.) сохраняются
- Без потери данных: Полная структура таксономии мигрирована
- Будущая гибкость: Новые термины могут использовать существующие или новые группировки vocabulary

---

## Справочник скриптов миграции

### Основные скрипты

#### `migrate_from_drupal6_universal.sql` (3.2K)
- Основная миграция из Drupal 6 в современную схему
- Создает UTF8 таблицы и мигрирует основные данные
- Объединяет все типы нод в единую таблицу `content`

#### `migrate_cck_fields.sql` (1.7K)
- Обрабатывает пользовательские поля Drupal 6 CCK
- Сохраняет данные полей в нормализованном формате

#### `update_migrated_users.sql` (1.2K)
- Очистка пользователей после миграции
- Устанавливает временные пароли, требующие сброса
- Создает пользователя администратора с правильными учетными данными

#### `detect_custom_fields.sql` (212B)
- Скрипт обнаружения для полей Drupal 6 CCK
- Интроспекция базы данных для планирования миграции

#### `create_admin_user.sql`
- Создает пользователя администратора по умолчанию для локальной разработки
- **Только для разработки** - пароль `admin`

---

## Миграции Spring Boot

### Автоматические миграции (Flyway, версия 9.22.3)

Приложение использует Flyway для автоматического управления эволюцией схемы. Для поддержки нескольких СУБД
скрипты организованы в общие и специфичные для вендора директории.

- `db/migration/common`: Скрипты, совместимые со всеми поддерживаемыми СУБД.
- `db/migration/mysql`: Скрипты только для MySQL.
- `db/migration/postgresql`: Скрипты только для PostgreSQL.

#### Конфигурация `ddl-auto` в Spring JPA
В конфигурации Spring JPA свойство `spring.jpa.hibernate.ddl-auto` контролирует поведение Hibernate по управлению схемой базы данных.
-   `validate`: (Рекомендуется для продакшена и с Flyway) Hibernate проверяет, соответствует ли схема базы данных сущностям, но не вносит изменений. Если есть несоответствия, приложение не запустится.
-   `update`: Hibernate пытается обновить схему базы данных, чтобы она соответствовала сущностям. **Использовать с осторожностью**, особенно в продакшене, так как это может привести к потере данных или непредсказуемому поведению.
-   `none`: Hibernate не выполняет никаких операций со схемой.

При использовании Flyway рекомендуется устанавливать `ddl-auto: validate` или `none`, так как Flyway полностью отвечает за эволюцию схемы.

| Миграция | Назначение | Изменения | Расположение |
|---|---|---|---|
| V1 | Начальная схема | Основные таблицы: users, roles, content, terms | `common` |
| V2 | Добавление поля `published` | Добавлено поле `published` в таблицу `content` | `common` |
| V3 | Тестовые данные | **Пользователь admin по умолчанию и тестовый контент** | `common` |
| V4 | Унификация пользователей | Консолидация мигрированных авторов | `common` |
| V5 | Система разрешений | Добавлены таблицы permissions и role_permissions | `common` |
| V6 | Описание разрешений | Добавлена колонка description в таблицу permissions | `common` |
| V7 | Настройки канала | Добавлена таблица channel_settings для конфигурации сайта | `common` |
| V8 | Настройка разрешений | Заполнение разрешений и назначение ролям | `mysql/postgresql` |
| V9 | Добавление индексов | Индексы производительности и уникальные ограничения | `mysql/postgresql` |
| V10 | Поле URL сайта | Добавлено поле site_url в таблицу channel_settings | `common` |

### Данные по умолчанию миграции V3

**⚠️ Важно**: Миграция V3 создает учетные данные для входа по умолчанию для веб-интерфейса CMS:

**Созданные роли:**
- `ADMIN` - Полный доступ к системе
- `EDITOR` - Доступ к управлению контентом

**Созданный пользователь по умолчанию:**
- Имя пользователя: `admin`
- Пароль: `admin` (BCrypt хеш)
- Email: `admin@example.com`
- Роль: `ADMIN`

**Тестовые данные:**
- Пример новостной статьи
- Общая категория
- Связи контента

---

## Аутентификация и контроль доступа

### Пользователи и пароли CMS по умолчанию

**⚠️ Важно**: Это пароли для входа на веб-сайт (веб-интерфейс CMS), а не пароли базы данных MySQL.

#### Для чистой базы данных (Новая установка)
После выполнения миграции V3 на свежей базе данных:

| Имя пользователя | Пароль | Роль | Email | Назначение |
|---|---|---|---|---|
| `admin` | `admin` | ADMIN | admin@example.com | Системный администратор |

#### Для мигрированной базы данных (Из Drupal 6)
После выполнения скриптов миграции + `update_migrated_users.sql`:

| Имя пользователя | Пароль | Роль | Email | Назначение |
|---|---|---|---|---|
| `admin` | `admin` | ADMIN | admin@phoebe.local | Системный администратор |
| Все мигрированные пользователи | `changeme123` | - | user{id}@migrated.local | Унаследованные (должны сбросить) |

### Пароли для подключения к базе данных (MySQL)

#### Для Dockerized MySQL
Если вы используете `docker-compose` для запуска MySQL (рекомендуемый способ):
- **Хост**: `localhost` (или `phoebe-mysql` из других контейнеров Docker)
- **Порт**: `3306`
- **Пользователь**: `root`
- **Пароль**: `root`
- **База данных**: `phoebe_db`

Эти учетные данные определены в файле `.env` и `docker-compose.yml`.

#### Для локальной MySQL
Если вы установили MySQL локально (не в Docker), используйте учетные данные, которые вы настроили при установке. Обычно это:
- **Хост**: `localhost`
- **Порт**: `3306`
- **Пользователь**: `root`
- **Пароль**: (ваш пароль root)
- **База данных**: `phoebe_db` (если вы ее создали)

### Безопасность паролей
- Все пароли CMS хранятся как **BCrypt хеши** (сила 10-12)
- Мигрированные пользователи **должны сменить пароль** при первом входе
- Пароль администратора CMS следует немедленно изменить в продакшене
- Учетные данные базы данных `root`/`root` предназначены **только для разработки** и должны быть изменены в продакшене.

### Система разрешений

Система использует именование разрешений **ресурс:действие**:

| Разрешение | Описание |
|---|---|
| `news:read` | Просмотр новостных статей |
| `news:create` | Создание новых статей |
| `news:update` | Редактирование существующих статей |
| `news:delete` | Удаление статей |
| `news:publish` | Публикация/снятие с публикации статей |
| `users:read` | Просмотр учетных записей пользователей |
| `users:create` | Создание новых пользователей |
| `users:update` | Редактирование учетных записей пользователей |
| `users:delete` | Удаление пользователей |
| `roles:*` | Разрешения на управление ролями |
| `terms:*` | Разрешения на управление таксономией |

### Разрешения ролей по умолчанию

**Роль ADMIN:**
- Все разрешения (полный доступ к системе)

**Роль EDITOR:**
- `news:read`, `news:create`, `news:update`, `news:publish`
- `terms:read`

---

## Взаимодействие с базами данных

Этот раздел описывает, как взаимодействовать с вашей базой данных MySQL, будь то в Docker-контейнере или установленной локально.
Для более подробной информации о работе с MySQL, пожалуйста, обратитесь к [Руководству по MySQL](./MYSQL_GUIDE_RU.md).

### Для Dockerized MySQL

Если ваша база данных MySQL запущена в Docker через `docker-compose` (контейнер `phoebe-mysql`), вы можете получить к ней доступ следующим образом:

1.  **Подключение к контейнеру MySQL:**
    ```bash
    docker exec -it phoebe-mysql mysql -u root -p
    ```
    В ответ на запрос `Enter password:` введите `root`.

2.  **Просмотр баз данных:**
    После подключения к MySQL-клиенту внутри контейнера:
    ```sql
    SHOW DATABASES;
    ```
    Вы должны увидеть `phoebe_db` среди прочих.

3.  **Выбор базы данных:**
    ```sql
    USE phoebe_db;
    ```

4.  **Просмотр таблиц:**
    ```sql
    SHOW TABLES;
    ```

5.  **Просмотр схемы таблицы:**
    ```sql
    DESCRIBE users; -- или любая другая таблица
    ```

6.  **Выполнение запросов:**
    ```sql
    SELECT * FROM users;
    SELECT COUNT(*) FROM content;
    ```

7.  **Выход из MySQL-клиента:**
    ```sql
    EXIT;
    ```

### Для локальной MySQL

Если у вас установлена MySQL непосредственно на вашей машине, вы можете использовать стандартный клиент `mysql`:

1.  **Подключение к локальной MySQL:**
    ```bash
    mysql -u root -p
    ```
    В ответ на запрос `Enter password:` введите пароль, который вы установили для пользователя `root` вашей локальной MySQL.

2.  **Просмотр баз данных:**
    ```sql
    SHOW DATABASES;
    ```

3.  **Выбор базы данных:**
    ```sql
    USE phoebe_db; -- Предполагается, что вы создали базу данных с таким именем
    ```

4.  **Просмотр таблиц:**
    ```sql
    SHOW TABLES;
    ```

5.  **Просмотр схемы таблицы:**
    ```sql
    DESCRIBE users; -- или любая другая таблица
    ```

6.  **Выполнение запросов:**
    ```sql
    SELECT * FROM users;
    SELECT COUNT(*) FROM content;
    ```

7.  **Выход из MySQL-клиента:**
    ```sql
    EXIT;
    ```

---

## Рекомендации по работе с продакшен-базами данных

Работа с базами данных в продакшен-среде требует особого внимания к безопасности, стабильности и аудиту. Прямой доступ к продакшен-базе данных извне (например, с локальной машины через терминал) крайне не рекомендуется для рутинных операций.

### Почему прямой доступ нежелателен?

1.  **Риски безопасности:**
    *   **Утечка учетных данных:** Прямое подключение увеличивает риск компрометации паролей.
    *   **Несанкционированный доступ:** Открытие портов для прямого доступа создает потенциальные уязвимости.
2.  **Человеческий фактор:**
    *   **Ошибки:** Ручное выполнение команд на продакшене может привести к случайному удалению или повреждению данных.
    *   **Отсутствие тестирования:** Изменения, сделанные напрямую, часто не проходят через стандартные процессы тестирования и ревью.
3.  **Отсутствие аудита и контроля:**
    *   **Сложность отслеживания:** Трудно отследить, кто, когда и какие изменения внес в базу данных.
    *   **Нарушение CI/CD:** Прямые изменения нарушают принцип "единого источника правды" (Git) и могут привести к рассинхронизации схемы.

### Рекомендуемые практики

1.  **Автоматизированные миграции (Flyway):**
    *   Все изменения схемы базы данных должны быть версионированы и применяться через систему миграций (например, Flyway). Это гарантирует, что схема всегда соответствует версии кода приложения.
    *   Разрабатывайте и тестируйте миграции локально, затем включайте их в процесс CI/CD.

2.  **Доступ через API приложения:**
    *   Все операции с данными (чтение, запись, обновление, удаление) должны выполняться через API вашего приложения. Это обеспечивает соблюдение бизнес-логики, валидации и безопасности.

3.  **Использование инструментов платформы:**
    *   Если ваш проект развернут на облачной платформе (виртуальные серверы, PaaS), используйте предоставляемые ею инструменты для мониторинга базы данных и выполнения ограниченных административных задач. Эти инструменты обычно более безопасны и интегрированы с системой аудита.

4.  **Десктопные SQL-клиенты через SSH-туннель (для экстренных случаев):**
    *   В редких случаях, когда требуется прямой доступ для отладки или экстренного исправления, используйте десктопный SQL-клиент (например, DataGrip, MySQL Workbench) с подключением через **SSH-туннель**. Это значительно безопаснее, чем открывать порт базы данных напрямую.

### Подключение к продакшен-базе данных через SSH-туннель

Для подключения к удаленной базе данных MySQL через SSH-туннель вам потребуется:
*   Доступ к SSH на сервере, где запущена база данных.
*   Приватный ключ SSH для аутентификации.
*   IP-адрес или доменное имя сервера.
*   Учетные данные для базы данных MySQL на удаленном сервере.

**Шаг 1: Создание SSH-туннеля**

Откройте терминал на вашей локальной машине и выполните команду:

```bash
ssh -L 3307:127.0.0.1:3306 user@your_server_ip -i /path/to/your/private_key.pem
```

*   `ssh`: Команда для установления SSH-соединения.
*   `-L 3307:127.0.0.1:3306`: Это опция для создания локального перенаправления портов (туннеля).
    *   `3307`: Локальный порт на вашей машине, который будет использоваться для подключения (вы можете выбрать любой свободный порт).
    *   `127.0.0.1`: IP-адрес, к которому будет подключаться SSH-сервер внутри удаленной сети (обычно это `localhost` относительно удаленного сервера, где запущена БД).
    *   `3306`: Порт MySQL на удаленном сервере.
*   `user@your_server_ip`: Имя пользователя и IP-адрес/доменное имя удаленного сервера.
*   `-i /path/to/your/private_key.pem`: Путь к вашему приватному SSH-ключу.

После выполнения этой команды и успешной аутентификации (возможно, потребуется ввести пароль для ключа), SSH-туннель будет установлен. Оставьте этот терминал открытым.

**Шаг 2: Подключение к базе данных через локальный порт**

Теперь, когда туннель активен, вы можете подключиться к удаленной базе данных, используя локальный порт `3307` (или тот, который вы указали) на вашей машине.

Через MySQL-клиент в терминале:

```bash
mysql -h 127.0.0.1 -P 3307 -u your_db_user -p your_db_name
```

*   `-h 127.0.0.1`: Указывает, что вы подключаетесь к локальному хосту.
*   `-P 3307`: Указывает локальный порт, который перенаправляет трафик через туннель.
*   `-u your_db_user`: Имя пользователя базы данных на удаленном сервере.
*   `-p`: Запросит пароль для пользователя базы данных.
*   `your_db_name`: Имя базы данных на удаленном сервере.

Или через графический SQL-клиент (DataGrip, MySQL Workbench):
*   **Host**: `127.0.0.1`
*   **Port**: `3307`
*   **User**: `your_db_user`
*   **Password**: `your_db_password`
*   **Database**: `your_db_name`

**Шаг 3: Закрытие SSH-туннеля**

Когда вы закончите работу с базой данных, просто закройте терминал, в котором был открыт SSH-туннель (или нажмите `Ctrl+C` в нем).

---

## Устранение неполадок

### Распространенные проблемы

**Миграция не удается из-за ошибок кодировки:**
```sql
-- Обеспечить кодировку UTF8
ALTER DATABASE phoebe_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

**Пользователь администратора уже существует:**
```sql
-- Проверить существующих пользователей
SELECT * FROM users WHERE username = 'admin';
-- Обновить пароль при необходимости
UPDATE users SET password = '$2a$12$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9P8jF4l3q4R4J8C' 
WHERE username = 'admin';
```

**Проверить успешность миграции:**
```sql
SELECT COUNT(*) FROM content;   -- Проверить мигрированные статьи
SELECT COUNT(*) FROM users;     -- Проверить мигрированных пользователей
SELECT COUNT(*) FROM terms;     -- Проверить мигрированную таксономию
```

### Инструкции по настройке базы данных

#### Для новой установки (Чистая база данных)
Самый простой способ запустить проект для локальной разработки — использовать Makefile.
```bash
# Запустить весь проект (БД + Бэкенд)
make run
```
При первом запуске Flyway автоматически применит все необходимые миграции. Учетные данные по умолчанию: `admin` / `admin`.

#### Для мигрированной базы данных (Из Drupal 6)
> **Важно**: Этот раздел описывает *ручной процесс* настройки мигрированной базы данных.
> **Для актуального и автоматизированного развертывания проекта с данными из Drupal 6, пожалуйста, обратитесь к [Актуальному руководству по миграции данных с Drupal 6](./MODERN_MIGRATION_GUIDE_RU.md).**
> Этот ручной процесс может быть полезен для отладки или понимания того, как данные были преобразованы.

1.  **Импортировать данные Drupal 6** (если доступны)
    *   **Примечание**: Для получения данных из старого дампа Drupal 6 см. **[Историческое руководство по резервному копированию и восстановлению данных Docker (контекст миграции Drupal 6)](./LEGACY_DOCKER_DATA_RECOVERY_GUIDE_RU.md)**.
2.  **Выполнить скрипты миграции** (если вы используете ручной процесс):
    ```bash
    mysql phoebe_db < db_data/migrate_from_drupal6_universal.sql
    mysql phoebe_db < db_data/update_migrated_users.sql
    ```
3.  **Запустить приложение** (`make run`), которое применит оставшиеся миграции Flyway.

### Контрольный список безопасности

- [ ] Изменить пароль администратора по умолчанию
- [ ] Принудительно сбросить пароли для всех мигрированных пользователей
- [ ] Проверить и настроить разрешения ролей
- [ ] Включить HTTPS в продакшене
- [ ] Настроить правильные учетные данные базы данных
- [ ] Настроить процедуры резервного копирования

---

## Связанная документация

- [Обзор проекта](./PROJECT_OVERVIEW_RU.md) - Полная информация о проекте
- [Миграция Drupal6](./MIGRATION_DRUPAL6_RU.md) - Детальный процесс миграции
- [Руководство разработчика](./DEVELOPER_GUIDE_RU.md) - Настройка локальной разработки
- [Быстрый старт](./QUICK_START_RU.md) - Краткие инструкции по запуску