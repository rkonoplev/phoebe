> [Вернуться к содержанию документации](./README.md)

# Руководство по развертыванию в продакшене

Этот документ описывает основные принципы и шаги для развертывания приложения в продакшен-окружении.

---

## Основные принципы

- **Неизменяемые артефакты**: Используйте Docker-образы как единицу развертывания. Не вносите изменения в работающие контейнеры.
- **Управление конфигурацией**: Вся конфигурация (порты, учетные данные, URL-ы) должна передаваться через переменные окружения.
- **Управление секретами**: Никогда не храните секреты (пароли, токены) в коде или Docker-образах. Используйте инструменты вашего окружения (Docker Secrets, Kubernetes Secrets, переменные окружения хостинга).
- **База данных**: В продакшене должна использоваться внешняя, управляемая база данных (например, AWS RDS, DigitalOcean Managed Database или аналоги). Не рекомендуется запускать базу данных в Docker-контейнере на том же хосте, что и приложение, без надлежащей настройки резервного копирования и отказоустойчивости.

---

## Конфигурация для продакшена

### Профиль Spring
В продакшен-окружении всегда используйте профиль `prod`.
```bash
SPRING_PROFILES_ACTIVE=prod
```
Этот профиль активирует настройки из `application-prod.yml`, который:
- Отключает детальное логирование SQL.
- Устанавливает `ddl-auto: validate`, чтобы предотвратить случайное изменение схемы базы данных.
- Ожидает, что все чувствительные данные будут переданы через переменные окружения.

### Docker Compose для продакшена
Для продакшен-развертывания рекомендуется использовать `docker-compose.prod.yml` в сочетании с `docker-compose.base.yml`.
Это позволяет использовать ту же модульную структуру, что и для локальной разработки, но с продакшен-настройками.

**Пример `docker-compose.prod.yml` (с учетом продакшен-настроек):**
```yaml
# docker-compose.prod.yml
services:
  phoebe-app:
    build:
      context: .
      dockerfile: Dockerfile.multistage # Используем многостадийную сборку
    container_name: phoebe-app
    restart: always
    depends_on:
      phoebe-mysql:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: prod # Активируем продакшен-профиль
      DB_HOST: your_external_db_host # Указываем хост внешней БД
      # ... другие переменные окружения для продакшена
    ports:
      - "8080:8080"
    # В продакшене не монтируем исходники, только готовый JAR
    # volumes:
    #   - ./backend:/app/backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 8
      start_period: 120s # Время на запуск приложения

  nextjs-app:
    build:
      context: ./frontends/nextjs
      dockerfile: Dockerfile # Используем тот же Dockerfile для фронтенда
    container_name: phoebe-nextjs
    restart: always
    depends_on:
      - phoebe-app
    ports:
      - "3000:3000"
    # В продакшене не монтируем исходники, только готовый билд
    # volumes:
    #   - ./frontends/nextjs:/app
    #   - /app/node_modules
    #   - /app/.next
```
**Примечание:** В продакшен-среде `phoebe-mysql` из `docker-compose.base.yml` должен быть заменен на внешнюю базу данных. Это достигается путем переопределения переменных окружения для `phoebe-app` или использованием другого `docker-compose.base.yml` для продакшена.

---

## Будущие темы для этого руководства

### 1. Сценарии развертывания

-   **Развертывание на виртуальный сервер (VPS)**
    -   **Содержание**: Базовая настройка Linux VPS (Ubuntu/CentOS), установка Docker и Docker Compose, настройка Nginx как обратного прокси с SSL (Let's Encrypt), настройка брандмауэра, запуск приложения с Docker Compose.
    -   **Связанные документы**: Может быть ссылка на более подробное "Руководство по развертыванию на VPS".
-   **Развертывание в облачные платформы (AWS, DigitalOcean, Heroku)**
    -   **Содержание**: Обзор соответствующих сервисов (например, AWS EC2/ECS/Fargate, RDS; DigitalOcean Droplets/App Platform/Managed Databases; Heroku Dynos/Postgres), базовые шаги настройки, соображения для управляемых сервисов по сравнению с самоуправляемыми.
    -   **Связанные документы**: Может быть ссылка на конкретные "Руководство по развертыванию на AWS", "Руководство по развертыванию на DigitalOcean" и т.д.

### 2. CI/CD для автоматизированного развертывания

-   **Сборка и публикация Docker-образов в GitHub Packages**
    -   **Содержание**: Настройка GitHub Actions для сборки продакшен Docker-образа (с версионированием, например, `phoebe-cms:1.0.0`), его тегирование и отправка в GitHub Container Registry (GHCR) или Docker Hub.
    -   **Связанные документы**: Может быть ссылка на "Руководство по CI/CD" для общей настройки CI.
-   **Настройка GitHub Actions для деплоя на сервер**
    -   **Содержание**: Использование GitHub Actions для SSH-подключения к VPS, получения последнего Docker-образа и перезапуска приложения (например, `docker compose pull && docker compose up -d`). Соображения для развертывания без простоев (zero-downtime deployments).
    -   **Связанные документы**: Может быть ссылка на "Руководство по CI/CD" или выделенное "Руководство по автоматизированному развертыванию".

### 3. Мониторинг и логирование

-   **Настройка сбора логов**
    -   **Содержание**: Настройка приложения для вывода логов в структурированном формате (например, JSON), использование драйверов логирования Docker (например, `json-file`, `syslog`, `gelf`), интеграция с внешними системами управления логами (например, ELK Stack, Grafana Loki, Logtail).
    -   **Связанные документы**: Может быть ссылка на "Руководство по стратегии логирования".
-   **Интеграция с системами мониторинга (Prometheus, Grafana)**
    -   **Содержание**: Предоставление метрик приложения (Spring Boot Actuator), настройка Prometheus для сбора метрик, настройка дашбордов Grafana для визуализации, базовые правила оповещения.
    -   **Связанные документы**: Может быть ссылка на "Руководство по мониторингу".

### 4. Резервное копирование и восстановление

-   **Стратегии резервного копирования базы данных**
    -   **Содержание**: Автоматическое ежедневное/еженедельное резервное копирование для управляемых баз данных, `mysqldump` для самоуправляемых баз данных, безопасное хранение резервных копий (например, S3).
    -   **Связанные документы**: Может быть ссылка на "Руководство по резервному копированию базы данных".
-   **План аварийного восстановления**
    -   **Содержание**: Шаги по восстановлению приложения и базы данных из резервных копий в случае крупного сбоя, соображения RTO (Recovery Time Objective) и RPO (Recovery Point Objective).
    -   **Связанные документы**: Может быть ссылка на "План аварийного восстановления".
