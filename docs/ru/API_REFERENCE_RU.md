> [Вернуться к содержанию документации](./README.md)

# Руководство по использованию API

Это руководство предоставляет практические примеры для тестирования эндпоинтов API Phoebe CMS
с использованием `curl` и Postman.

## Содержание
- [Работа с Postman](#работа-с-postman)
- [Ограничение частоты запросов (Rate Limiting)](#ограничение-частоты-запросов-rate-limiting)
- [Публичные эндпоинты (без аутентификации)](#публичные-эндпоинты-без-аутентификации)
- [Эндпоинты администратора (требуется аутентификация)](#эндпоинты-администратора-требуется-аутентификация)
- [Параметры пагинации](#параметры-пагинации)
- [Тестирование ограничения запросов](#тестирование-ограничения-запросов)
- [Коды состояния HTTP](#коды-состояния-http)
- [Пример ответа об ошибке валидации](#пример-ответа-об-ошибке-валидации)
- [Примечания](#примечания)
- [Альтернативная документация: Swagger UI](#альтернативная-документация-swagger-ui)

---

## Работа с Postman

Хотя все примеры используют `curl` для универсального доступа из терминала, для более удобного
тестирования настоятельно рекомендуется использовать такой инструмент, как [Postman](https://www.postman.com/).

**Как импортировать команду `curl` в Postman:**
1.  Откройте Postman и нажмите кнопку `Import`.
2.  Выберите вкладку `Raw text`.
3.  Скопируйте и вставьте любую команду `curl` из этого руководства.
4.  Postman автоматически создаст новый, готовый к использованию запрос.

---

## Ограничение частоты запросов (Rate Limiting)

Все эндпоинты API ограничены по частоте запросов с одного IP-адреса:
- **Публичный API** (`/api/public/**`): 100 запросов в минуту
- **API администратора** (`/api/admin/**`): 50 запросов в минуту

Ответы включают заголовок `X-Rate-Limit-Remaining`. Если лимит превышен, API вернет
ошибку `HTTP 429 Too Many Requests` с телом JSON:
```json
{"error":"Rate limit exceeded","retryAfter":60}
```

---

## Публичные эндпоинты (без аутентификации)

### 1. Получить все опубликованные новости (с пагинацией)
```bash
curl -i "http://localhost:8080/api/public/news?page=0&size=10&sort=publicationDate,desc"
```

### 2. Получить опубликованную новость по ID
```bash
curl -i "http://localhost:8080/api/public/news/1"
```

### 3. Получить опубликованные новости по ID термина (категории/тега)
```bash
curl -i "http://localhost:8080/api/public/news/term/5?page=0&size=15"
```

### 4. Получить опубликованные новости по нескольким ID терминов
```bash
curl -i "http://localhost:8080/api/public/news/terms?termIds=1,3,5&page=0&size=20"
```

### 5. Проверить заголовки Rate Limiting
```bash
curl -i "http://localhost:8080/api/public/news" | grep "X-Rate-Limit"
```

---

## Эндпоинты администратора (требуется аутентификация)

### Аутентификация
Для доступа к эндпоинтам администратора требуется аутентификация. В примерах используется базовая HTTP-аутентификация (`-u admin:password`). В продакшене рекомендуется использовать более надежные механизмы аутентификации, такие как OAuth 2.0 или JWT, как описано в [Руководстве по аутентификации](./AUTHENTICATION_GUIDE_RU.md).

### 1. Получить все новости (опубликованные + неопубликованные)
```bash
curl -u admin:password -i "http://localhost:8080/api/admin/news?page=0&size=10"
```

### 2. Создать новость

- **Эндпоинт**: `POST /api/admin/news`
- **Описание**: Создает новую новостную статью.

**Поля тела запроса:**
| Поле              | Тип       | Описание                                          | Обязательно |
|-------------------|-----------|---------------------------------------------------|-------------|
| `title`           | `String`  | Заголовок статьи. Макс. 255 символов.             | Да          |
| `body`            | `String`  | Полное содержание статьи.                         | Нет         |
| `teaser`          | `String`  | Краткое содержание для превью.                    | Нет         |
| `published`       | `boolean` | `true` для немедленной публикации, `false` для черновика. | Да          |
| `publicationDate` | `String`  | Дата и время в формате ISO-8601 (например, `2024-01-15T10:30:00`). | Нет         |
| `termIds`         | `Массив`  | Массив числовых ID для связанных терминов.        | Нет         |

**Пример запроса:**
```bash
curl -u admin:password \
  -H "Content-Type: application/json" \
  -X POST http://localhost:8080/api/admin/news \
  -d '{
    "title": "Заголовок срочных новостей",
    "body": "Полное содержание статьи здесь...",
    "teaser": "Краткое содержание для превью",
    "published": true,
    "publicationDate": "2024-01-15T10:30:00",
    "termIds": [5]
  }'
```

### 3. Обновить новость

- **Эндпоинт**: `PUT /api/admin/news/{id}`
- **Описание**: Обновляет существующую новостную статью. Все поля необязательны.

**Пример запроса:**
```bash
curl -u admin:password \
  -H "Content-Type: application/json" \
  -X PUT http://localhost:8080/api/admin/news/1 \
  -d '{
    "title": "Обновленный заголовок новости",
    "body": "Обновленное содержание...",
    "published": false
  }'
```

### 4. Удалить новость
```bash
curl -u admin:password -X DELETE "http://localhost:8080/api/admin/news/1"
```

---

## API настроек канала

### 1. Получить настройки канала (публично)
```bash
curl -i "http://localhost:8080/api/public/channel-settings"
```

### 2. Получить настройки канала (администратор)
```bash
curl -u admin:password -i "http://localhost:8080/api/admin/channel-settings"
```

### 3. Обновить настройки канала (только администратор)

- **Эндпоинт**: `PUT /api/admin/channel-settings`
- **Описание**: Обновляет общесайтовые настройки конфигурации.

**Поля тела запроса:**
| Поле               | Тип      | Описание                                           | Обязательно |
|--------------------|----------|----------------------------------------------------|-------------|
| `siteTitle`        | `String` | Заголовок сайта для вкладки браузера. Макс. 255 символов. | Нет         |
| `metaDescription`  | `String` | Мета-описание. Макс. 500 символов.                 | Нет         |
| `metaKeywords`     | `String` | Мета-ключевые слова. Макс. 500 символов.           | Нет         |
| `headerHtml`       | `String` | HTML-код для шапки сайта (проверяется SafeHtml)   | Нет         |
| `logoUrl`          | `String` | URL логотипа сайта. Макс. 500 символов.            | Нет         |
| `footerHtml`       | `String` | HTML-код для подвала сайта (проверяется SafeHtml) | Нет         |
| `mainMenuTermIds`  | `String` | Строковое представление JSON-массива ID терминов для главного меню (например, `"[1,2,3]"`) | Нет         |
| `siteUrl`          | `String` | Базовый URL сайта. Макс. 255 символов.             | Нет         |

**Пример запроса:**
```bash
curl -u admin:password \
  -H "Content-Type: application/json" \
  -X PUT http://localhost:8080/api/admin/channel-settings \
  -d '{
    "siteTitle": "Мой новостной сайт",
    "metaDescription": "Последние новости и обновления",
    "metaKeywords": "новости, обновления, срочные",
    "logoUrl": "/assets/logo.png",
    "mainMenuTermIds": "[1,2,3]",
    "siteUrl": "https://dniester.ru"
  }'
```

**Ограничения безопасности для HTML-полей:**

⚠️ **Ограничения HTML-контента:**
- **Нельзя вставить JavaScript**: Теги script и JavaScript-код заблокированы
- **Нельзя использовать iframe**: Невозможно встраивать внешний контент или видео
- **Нельзя добавить ссылки**: Теги ссылок (`<a>`) не разрешены
- **Нельзя вставлять изображения**: Теги изображений (`<img>`) не разрешены
- **Только разрешенные теги**: `b`, `i`, `u`, `strong`, `em`, `p`, `br`

Эти ограничения предотвращают XSS-атаки и обеспечивают безопасность контента.

**Реализация валидации на бэкенде:**

✅ **Валидация на стороне сервера:**
- Аннотация `@ValidUrl` валидирует HTTP/HTTPS URL для поля `siteUrl`
- Аннотация `@ValidJsonArray` валидирует формат JSON-массива для поля `mainMenuTermIds`
- Аннотация `@SafeHtml` ограничивает HTML только безопасными тегами
- Все валидации возвращают четкие сообщения об ошибках

**Рекомендации для реализации фронтенда:**

✅ **Для панели таксономии (поле mainMenuTermIds):**
- Используйте поле `mainMenuTermIds` для хранения JSON-массива ID терминов
- HTML-форматирование ограничено только безопасными тегами
- Фронтенд должен обеспечивать дополнительную валидацию ввода

✅ **Рекомендации по валидации фронтенда:**
- Добавьте клиентскую валидацию URL для поля `siteUrl`
- Предупреждайте пользователей об ограничениях HTML перед вводом контента
- Показывайте превью HTML с безопасными тегами перед сохранением
- Валидируйте JSON-формат для поля `mainMenuTermIds`
- Предоставляйте понятные сообщения об ошибках валидации

---

## Параметры пагинации

Все списочные эндпоинты поддерживают пагинацию:
- `page`: Номер страницы (начиная с 0, по умолчанию: 0)
- `size`: Количество элементов на странице (по умолчанию: 10, макс: 100)
- `sort`: Поле и направление сортировки (например, `publicationDate,desc`)

### Пример с пагинацией:
```bash
curl -i "http://localhost:8080/api/public/news?page=1&size=5&sort=title,asc"
```

### Формат ответа:
```json
{
  "content": [
    {
      "id": 1,
      "title": "Пример заголовка новости",
      "teaser": "Краткое содержание...",
      "publicationDate": "2024-01-15T10:30:00"
    }
  ],
  "totalElements": 25,
  "totalPages": 3,
  "size": 10,
  "number": 0,
  "first": true,
  "last": false,
  "numberOfElements": 10,
  "empty": false
}
```

---

## Тестирование ограничения запросов

### Тест публичного API (100/мин):
```bash
for i in {1..105}; do 
  curl -s -o /dev/null -w "%{http_code}\n" http://localhost:8080/api/public/news
done
```

### Тест API администратора (50/мин):
```bash
for i in {1..55}; do 
  curl -s -o /dev/null -w "%{http_code}\n" -u admin:password http://localhost:8080/api/admin/news
done
```
*Ожидается: Сначала запросы вернут `200`, затем `429` после превышения лимита.*

---

## Коды состояния HTTP

Ниже приведены стандартные коды состояния HTTP, которые могут быть возвращены API:

| Код | Статус                 | Описание                                                              |
|-----|------------------------|-----------------------------------------------------------------------|
| `200` | `OK`                   | Запрос успешно обработан.                                             |
| `201` | `Created`              | Ресурс успешно создан (например, `POST /api/admin/news`).             |
| `204` | `No Content`           | Запрос успешно обработан, но нет содержимого для возврата (например, `DELETE`). |
| `400` | `Bad Request`          | Некорректный запрос, например, из-за ошибок валидации.                |
| `401` | `Unauthorized`         | Требуется аутентификация.                                             |
| `403` | `Forbidden`            | Аутентификация прошла успешно, но у пользователя нет прав доступа.     |
| `404` | `Not Found`            | Ресурс не найден.                                                     |
| `429` | `Too Many Requests`    | Превышен лимит частоты запросов.                                      |
| `500` | `Internal Server Error`| Внутренняя ошибка сервера.                                            |

---

## Пример ответа об ошибке валидации

При возникновении ошибок валидации (например, при некорректных данных в теле запроса `POST` или `PUT`), API возвращает стандартизированный JSON-ответ:

```json
{
  "timestamp": "2024-01-15T10:30:00.123+00:00",
  "status": 400,
  "error": "Bad Request",
  "code": "VALIDATION_ERROR",
  "message": "Ошибка валидации входных данных",
  "details": [
    {
      "field": "title",
      "message": "не должно быть пустым"
    },
    {
      "field": "publicationDate",
      "message": "должен быть валидным форматом ISO-8601"
    }
  ],
  "path": "/api/admin/news"
}
```

---

## Примечания
- Все примеры предполагают локальную разработку: `http://localhost:8080`
- Замените `admin:password` на ваши настроенные учетные данные.
- Лимиты запросов действуют для одного IP-адреса и сбрасываются каждую минуту.
- Используйте флаг `-i`, чтобы видеть заголовки ответа, включая информацию о лимитах.
- Никогда не используйте реальные продакшн-пароли в скриптах или документации.

---

## Альтернативная документация: Swagger UI

В дополнение к этому руководству, вы можете получить доступ к живой документации по API и тестировать
эндпоинты в вашем браузере:

[http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)

Swagger UI полезен для изучения всех доступных эндпоинтов, просмотра схем и выполнения тестовых
запросов прямо в браузере.
