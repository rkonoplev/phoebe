> [Вернуться к содержанию документации](./README.md)

# Руководство по Docker

> Для определения ключевых терминов и технологий, пожалуйста, обратитесь к **[Глоссарию](./GLOSSARY_RU.md)**.

## Содержание
- [Философия Docker в проекте](#философия-docker-в-проекте)
- [Структура файлов Docker Compose](#структура-файлов-docker-compose)
  - [`docker-compose.base.yml`](#docker-composebaseyml)
  - [`docker-compose.hybrid.yml`](#docker-composehybridyml)
  - [`docker-compose.prod.yml`](#docker-composeprodyml)
- [Выбор режима разработки](#выбор-режима-разработки)
- [Прямое использование Docker Compose](#прямое-использование-docker-compose)
- [Сборка для продакшена](#сборка-для-продакшена)
- [Управление данными и кэшем](#управление-данными-и-кэшем)
- [Полная очистка Docker](#полная-очистка-docker)
- [Устранение проблем](#устранение-проблем)

---

## Философия Docker в проекте

Проект использует Docker для создания консистентной, изолированной и простой в использовании среды разработки.
Основная цель — минимизировать количество зависимостей, которые нужно устанавливать на локальную машину разработчика.

В идеале, все что вам нужно — это **Docker Desktop**.

Проект предлагает два основных режима работы, чтобы удовлетворить потребности как бэкенд-, так и фронтенд-разработчиков.

---

## Структура файлов Docker Compose

Вместо одного монолитного `docker-compose.yml`, мы используем модульный подход, разделяя конфигурацию на
несколько файлов. Это позволяет гибко комбинировать сервисы для разных сценариев.

### `docker-compose.base.yml`
- **Назначение**: Базовый файл, который определяет общие для всех режимов сервисы и ресурсы.
- **Содержимое**:
  - Сервис базы данных `phoebe-mysql`.
  - Именованные тома (volumes) для персистентности данных: `mysql_data`, `gradle_cache`, `node_modules`, `nextjs_cache`.

### `docker-compose.hybrid.yml`
- **Назначение**: Описывает **гибридный режим** разработки.
- **Для кого**: Для бэкенд-разработчиков.
- **Как работает**:
  - Использует `Dockerfile.dev` для сборки бэкенда.
  - Исходный код бэкенда монтируется в контейнер (`volumes`), что позволяет Spring Boot DevTools мгновенно
    подхватывать изменения в Java-коде.
  - **Требует локальный JDK** для полноценной работы IDE (анализ кода, запуск юнит-тестов).

### `docker-compose.prod.yml`
- **Назначение**: Описывает **продакшен-подобный режим** разработки.
- **Для кого**: Для фронтенд-разработчиков, тестировщиков, CI/CD.
- **Как работает**:
  - Использует `Dockerfile.multistage` для создания легковесного, оптимизированного образа бэкенда.
  - В финальный образ попадает только скомпилированный `.jar` файл, без исходного кода.
  - **Не требует локального JDK**.

---

## Выбор режима разработки

Управление режимами осуществляется через `Makefile`, который автоматически подставляет нужные файлы `docker-compose`.

- **Гибридный режим (по умолчанию):**
  ```bash
  make run  # или make run-hybrid
  ```
  Эта команда выполнит: `docker compose -f docker-compose.base.yml -f docker-compose.hybrid.yml up --build`

- **Продакшен-подобный режим:**
  ```bash
  make run-prod
  ```
  Эта команда выполнит: `docker compose -f docker-compose.base.yml -f docker-compose.prod.yml up --build`

> Для более подробного сравнения режимов обратитесь к **[Подходам к локальной разработке](./DEVELOPMENT_APPROACHES_RU.md)**.

---

## Прямое использование Docker Compose

Если вы предпочитаете работать без `Makefile`, вы можете запускать `docker compose` напрямую, указывая нужные
файлы конфигурации с помощью флага `-f`.

- **Запуск в гибридном режиме:**
  ```bash
  docker compose -f docker-compose.base.yml -f docker-compose.hybrid.yml up --build
  ```

- **Запуск в продакшен-подобном режиме:**
  ```bash
  docker compose -f docker-compose.base.yml -f docker-compose.prod.yml up --build
  ```

- **Остановка:**
  ```bash
  # Достаточно остановить по одному из сценариев, чтобы погасить все
  docker compose -f docker-compose.base.yml -f docker-compose.hybrid.yml down
  ```

---

## Сборка для продакшена

Для создания финального Docker-образа, который будет развертываться на сервере, используется `Dockerfile.multistage`.

1.  **Убедитесь, что ваш код закоммичен**, так как сборка будет происходить в чистой среде.

2.  **Выполните команду сборки из корня проекта:**
    ```bash
    docker build -t phoebe-cms:latest -f Dockerfile.multistage .
    ```
    - `-t phoebe-cms:latest`: Задает имя и тег для вашего образа. Рекомендуется использовать версионирование.
    - `-f Dockerfile.multistage`: Явно указывает, какой Dockerfile использовать.
    - `.`: Контекст сборки (весь проект).

3.  **Запустите собранный образ:**
    ```bash
    # Пример запуска с передачей переменных окружения
    docker run -d -p 8080:8080 \
      -e SPRING_PROFILES_ACTIVE=prod \
      -e DB_HOST=your_db_host \
      -e DB_USER=your_db_user \
      -e DB_PASSWORD=your_db_password \
      phoebe-cms:latest
    ```

---

## Управление данными и кэшем

Проект использует именованные тома (named volumes) для сохранения данных между запусками.

- **`mysql_data`**: Хранит данные вашей базы данных MySQL.
- **`gradle_cache`**: Хранит скачанный Gradle и все зависимости. Это значительно ускоряет последующие сборки бэкенда.
- **`node_modules`**: Хранит JavaScript-зависимости для фронтенда.
- **`nextjs_cache`**: Хранит кэш сборки Next.js.

Для полного сброса окружения, включая все эти данные, используйте команду:
```bash
make reset
```
**Внимание:** Эта команда безвозвратно удалит вашу локальную базу данных.

---

## Полная очистка Docker

Иногда требуется полностью очистить Docker от неиспользуемых контейнеров, образов, сетей и томов (volumes).
Это освободит место или позволит начать с "чистого листа".
**Будьте осторожны:** эти команды удалят все данные, не связанные с запущенными контейнерами.
Они могут затронуть другие проекты Docker на вашей машине.

### 1. Удаление контейнеров и томов текущего проекта

Перед полной очисткой остановите и удалите контейнеры и тома текущего проекта.
Перейдите в корневую директорию проекта (где находится `docker-compose.yml`) и выполните:

```bash
cd /Users/rk/dev/java/phoebe # Убедитесь, что вы в корне проекта
docker-compose down --volumes
```
Эта команда остановит и удалит все сервисы, сети и именованные тома,
определенные в файлах `docker-compose.*.yml` вашего проекта.

### 2. Удаление всех запущенных контейнеров

Остановите все запущенные контейнеры (если есть):
```bash
docker stop $(docker ps -aq)
```
*   `docker ps -aq` выводит ID всех контейнеров (запущенных и остановленных).
*   `docker stop` останавливает их.

### 3. Удаление всех остановленных контейнеров

Удалите все остановленные контейнеры:
```bash
docker rm $(docker ps -aq)
```
*   Эта команда удалит все контейнеры, которые были остановлены на предыдущем шаге.

### 4. Удаление всех неиспользуемых ресурсов Docker (образы, сети, кэш сборки)

Для удаления всех остановленных контейнеров, неиспользуемых образов (dangling images),
неиспользуемых сетей и кэша сборки:

```bash
docker system prune
```
Docker запросит подтверждение. Введите `y` и нажмите Enter.

### 5. Удаление всех неиспользуемых томов Docker

`docker system prune` по умолчанию не удаляет тома, чтобы предотвратить случайную потерю данных.
Для удаления всех томов, которые не используются ни одним контейнером:

```bash
docker volume prune
```
Docker запросит подтверждение. Введите `y` и нажмите Enter.

### 6. Удаление всех образов Docker

Если вы хотите удалить **все** образы, даже те, которые могут быть использованы в других проектах:
```bash
docker rmi -f $(docker images -aq)
```
*   `docker images -aq` выводит ID всех образов.
*   `docker rmi -f` принудительно удаляет их.
*   **Будьте осторожны с этой командой**, так как она удалит все скачанные образы,
    и при следующем запуске Docker придется скачивать их заново.

### Рекомендуемый порядок действий для полной очистки

1.  Перейдите в корневую папку проекта `phoebe`:
    ```bash
    cd /Users/rk/dev/java/phoebe
    ```
2.  Остановите и удалите контейнеры и тома, связанные с вашим проектом:
    ```bash
    docker-compose down --volumes
    ```
3.  Выполните общую очистку Docker (удалит неиспользуемые контейнеры, образы, сети и кэш сборки):
    ```bash
    docker system prune
    ```
    На вопрос `Are you sure you want to continue? [y/N]` введите `y` и нажмите Enter.
4.  Выполните очистку неиспользуемых томов:
    ```bash
    docker volume prune
    ```
    На вопрос `Are you sure you want to continue? [y/N]` введите `y` и нажмите Enter.

После этих шагов ваш Docker будет максимально очищен.

---

## Устранение проблем

### Принудительная полная пересборка

Иногда кэш Docker может "застрять", особенно после переключения веток или внесения значительных изменений
в файлы конфигурации (`docker-compose.*.yml`, `Dockerfile` и т.д.). Если приложение не запускается с ошибкой,
которая кажется связанной со старым кодом или конфигурацией (например, конфликт миграции `Flyway`, который
вы уже исправили), вам может потребоваться принудительная полная пересборка.

Флаг `--force-recreate` заставляет Docker Compose пересоздать все контейнеры, гарантируя, что все ваши
последние изменения будут применены.

1.  **Остановите все контейнеры:**
    ```bash
    make stop
    ```

2.  **Запустите проект с принудительным пересозданием:**
    ```bash
    docker compose -f docker-compose.base.yml -f docker-compose.hybrid.yml up --build --force-recreate
    ```

**Примечание:** Вам не нужно делать это каждый раз. Это шаг для устранения неполадок, когда `make run`
не подхватывает ваши изменения. После выполнения этой одноразовой команды вы можете вернуться к обычному
использованию `make run`.