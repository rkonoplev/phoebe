> [Вернуться к содержанию документации](./README.md) | [Краткое руководство по началу работы](./QUICK_START_RU.md) | [Руководство разработчика](./DEVELOPER_GUIDE_RU.md)

# Тестирование и разработка с Makefile

## Содержание

- [Быстрая справка](#быстрая-справка)
- [Выбор режима разработки](#выбор-режима-разработки)
- [Рабочие процессы разработки](#рабочие-процессы-разработки)
  - [1. Разработка полного стека](#1-разработка-полного-стека)
  - [2. Разработка только бэкенда](#2-разработка-только-бэкенда)
  - [3. Рабочие процессы тестирования](#3-рабочие-процессы-тестирования)
    - [Быстрые интеграционные тесты](#быстрые-интеграционные-тесты)
    - [Полный набор тестов](#полный-набор-тестов)
    - [Проверки качества кода](#проверки-качества-кода)
- [Требования к окружению](#требования-к-окружению)
- [Детали конфигурации](#детали-конфигурации)
- [Устранение неполадок](#устранение-неполадок)
- [Лучшие практики](#лучшие-практики)
- [Интеграция с IDE](#интеграция-с-ide)
- [Интеграция CI/CD](#интеграция-cicd)

Этот документ объясняет, как использовать команды Makefile для разработки и тестирования.

## Быстрая справка

| Команда | Описание | Случай использования |
|:---|:---|:---|
| `make run-hybrid` | **(По умолчанию)** Запустить в гибридном режиме. | Для бэкенд-разработчиков (требуется локальный JDK). |
| `make run-prod` | Запустить в продакшен-подобном режиме. | Для фронтенд-разработчиков (нужен только Docker). |
| `make run` | Псевдоним для `make run-hybrid`. | Быстрый запуск в режиме по умолчанию. |
| `make stop` | Остановить проект. | Чистое завершение. |
| `make reset` | **Удалить все контейнеры и данные БД**. | Полный сброс окружения. |
| `make test` | Запустить интеграционные тесты (Testcontainers). | Быстрая обратная связь. |
| `make all-tests` | Запустить все тесты (юнит + интеграционные). | Полная проверка. |
| `make boot` | Запустить бэкенд локально. | Разработка с локальным MySQL. |
| `make clean` | Очистить артефакты сборки. | Свежий старт. |
| `make lint` | Запустить статический анализ. | Проверка качества кода. |
| `make coverage` | Сгенерировать отчет покрытия. | Отчеты покрытия. |

## Выбор режима разработки

Проект поддерживает два режима запуска для локальной разработки, чтобы соответствовать разным задачам.

### Режим 1: Гибридный (`make run-hybrid` или `make run`)
- **Для кого:** Идеально для **бэкенд-разработчиков**, активно работающих с Java-кодом.
- **Как работает:** Код компилируется внутри Docker-контейнера, но `volumes` позволяют мгновенно подхватывать изменения. Требует **локально установленный JDK** для полноценной работы IDE (анализ кода, запуск юнит-тестов).
- **Когда использовать:** Когда вы пишете Java-код и хотите быстро запускать юнит-тесты прямо из IDE.

### Режим 2: Продакшен-подобный (`make run-prod`)
- **Для кого:** Идеально для **фронтенд-разработчиков, тестировщиков** или для финальной проверки.
- **Как работает:** Использует многостадийную сборку (multi-stage build) для создания легковесного, самодостаточного образа бэкенда. **Локальный JDK не требуется.**
- **Когда использовать:** Когда вам просто нужен работающий бэкенд, и вы не планируете вносить изменения в Java-код.

> Подробное сравнение подходов доступно в документе **[Подходы к локальной разработке](./DEVELOPMENT_APPROACHES_RU.md)**.

## Рабочие процессы разработки

### 1. Разработка полного стека
Для разработки фронтенда и бэкенда с живой перезагрузкой:

```bash
# Для бэкенд-разработчиков (режим по умолчанию)
make run

# Для фронтенд-разработчиков (не требует локальной Java)
make run-prod
```

**Доступ к сервисам:**
- API: [http://localhost:8080](http://localhost:8080)
- Swagger: [http://localhost:8080/swagger-ui/index.html](http://localhost:8080/swagger-ui/index.html)
- Фронтенд: [http://localhost:3000](http://localhost:3000) (если доступен)

> **Подсказка**: Учетные данные для входа (логины и пароли) для разных ролей описаны в файле **[DATABASE_GUIDE_RU.md](./DATABASE_GUIDE_RU.md)**.

```bash
# Остановить по завершении
make stop
```

### 2. Разработка только бэкенда
Для разработки API без фронтенда:

```bash
# Вариант A: С Docker Compose (рекомендуется)
make run

# Вариант B: Локальная разработка (требует локальный MySQL)
make boot
```

### 3. Рабочие процессы тестирования

#### Быстрые интеграционные тесты
```bash
# Запустить интеграционные тесты с Testcontainers
make test
```
- Использует Testcontainers (Docker Compose не нужен)
- Запускает свежий контейнер MySQL для каждого запуска тестов
- Быстрая обратная связь

#### Полный набор тестов
```bash
# Запустить все тесты (юнит + интеграционные)
make all-tests
```
- Комплексная проверка
- Включает покрытие кода
- Использовать перед коммитами/PR

#### Проверки качества кода
```bash
# Запустить статический анализ
make lint

# Сгенерировать отчет покрытия
make coverage
```

## Требования к окружению
- **Для `make run-hybrid`**: Docker и Java (JDK).
- **Для `make run-prod`**: Только Docker.
- **Для `make test` и `make all-tests`**: Docker (для Testcontainers) и Java (JDK) для запуска Gradle.
- **Для `make boot`**: Локальный MySQL и Java (JDK).

## Детали конфигурации

### Docker Compose (`make run-*`)
- **MySQL**: Постоянные данные в Docker volume.
- **Бэкенд**: В гибридном режиме (`run-hybrid`) используется горячая перезагрузка с Spring Boot DevTools.
- **Фронтенд**: Живая перезагрузка (если настроена).

### Testcontainers (`make test`)
- **MySQL**: Свежий контейнер для каждого запуска тестов.
- **Изоляция**: Каждый тест получает чистую базу данных.
- **Производительность**: Оптимизировано для CI/CD.

### Локальная разработка (`make boot`)
- **MySQL**: Ваша локальная установка.
- **Гибкость**: Прямой доступ к базе данных.
- **Скорость**: Без накладных расходов контейнера.

## Устранение неполадок

### Проблемы со сборкой и кэшем
Если приложение ведет себя неожиданно после изменений в коде (особенно в `build.gradle`), попробуйте `make reset`, чтобы полностью очистить окружение. **Внимание: это удалит данные в БД.**

### Проблемы с Docker
```bash
# Если контейнеры зависли
make stop
docker system prune -f

# Перезапуск
make run
```

### Проблемы с тестами
```bash
# Очистить и повторить
make clean
make test
```

### Проблемы с локальным MySQL
```bash
# Проверить статус MySQL
brew services list | grep mysql

# Запустить MySQL (macOS с Homebrew)
brew services start mysql

# Создать базу данных
mysql -u root -p -e "CREATE DATABASE IF NOT EXISTS phoebe_db;"
```

## Лучшие практики

1. **Используйте `make test` для быстрой обратной связи** во время разработки.
2. **Используйте `make all-tests` перед коммитами** для полной проверки.
3. **Используйте `make run-hybrid` (или `make run`) для разработки бэкенда.**
4. **Используйте `make run-prod` для разработки фронтенда или тестирования.**
5. **Всегда выполняйте `make stop`** для очистки ресурсов Docker.

## Интеграция с IDE

### IntelliJ IDEA
- Конфигурации запуска могут использовать команды `make`.
- Интеграция терминала: `Tools > Terminal`.
- Внешние инструменты: `Tools > External Tools`.

### VS Code
- Задачи можно настроить для запуска команд `make`.
- Встроенный терминал поддерживает `make`.
- Доступны расширения для синтаксиса Makefile.

## Интеграция CI/CD

Рабочий процесс GitHub Actions использует Testcontainers напрямую:
```yaml
- name: Run tests
  run: cd backend && ./gradlew clean build integrationTest jacocoTestReport --no-daemon
```

Это эквивалентно локальному запуску `make all-tests`.