> [Вернуться к содержанию документации](./README.md)

# История разработки и улучшения

Этот документ отслеживает историю значимых улучшений, текущие задачи и возможные направления развития проекта.

---

## Завершенные задачи и архитектурные решения

Этот раздел служит журналом изменений, документируя ключевые реализованные возможности и рефакторинги.

### Архитектура и Дизайн
- **Слоёная архитектура**: Реализовано четкое разделение на слои Controller, Service и Repository.
- **Принцип единой ответственности**: Логика разделена по доменным областям (новости, роли, авторизация).
- **DTO-паттерн**: Используются Data Transfer Objects для всех API-запросов и ответов.
- **Централизованная авторизация**: Логика проверки прав доступа вынесена в `AuthorizationService`.
- **Автоматическое маппинг**: Внедрен MapStruct для автоматического преобразования между DTO и сущностями.

### Безопасность
- **Аутентификация и авторизация**: Интегрирован Spring Security с базовой аутентификацией.
- **Ролевая модель (RBAC)**: Реализована система с ролями (ADMIN, EDITOR) и гранулярными разрешениями.
- **Защита эндпоинтов**: Административные API защищены и требуют соответствующих ролей.
- **Устранение уязвимости Next.js**: Обновлен пакет `next` для закрытия уязвимости RCE (Remote Code Execution).

### Производительность
- **Кэширование**: Внедрено кэширование на уровне методов (`@Cacheable`) с использованием Caffeine.
- **Ограничение частоты запросов (Rate Limiting)**: Реализована защита API от флуда с помощью Bucket4j.
- **Оптимизация транзакций**: Методы сервисов, предназначенные только для чтения, аннотированы
  `@Transactional(readOnly = true)`.
- **Предотвращение N+1 запросов**: Добавлены `@EntityGraph` аннотации для жадной загрузки связанных сущностей.
- **SQL логирование и диагностика**: Настроено детальное логирование SQL с форматированием и трассировкой параметров в профиле `local`.
- **Пакетные операции**: Настроена группировка INSERT/UPDATE операций для сокращения обращений к БД.

### База данных
- **Доступ к данным**: Проект использует блокирующий стек **Spring Data JPA** для простоты и надежности.
- **Управление миграциями**: Схема базы данных управляется с помощью Flyway, обеспечивая версионирование.
- **Исправление совместимости миграций**: Устранена ошибка в миграции `V11` для поддержки синтаксиса MySQL
  (замена `||` на `CONCAT()`), обеспечив кросс-совместимость.
- **MySQL как единая СУБД**: Проект использует MySQL для всех сред для обеспечения консистентности.

### Качество кода и CI/CD
- **Статический анализ**: Настроены и интегрированы Checkstyle и PMD для поддержания качества кода.
- **Тестовое покрытие**: Интегрирован JaCoCo для анализа покрытия кода тестами.
- **Рефакторинг тестовой структуры**: Проведено полное разделение тестов на юнит- и интеграционные.
- **Настройка Gradle**: `build.gradle` сконфигурирован для раздельного запуска тестов.
- **Унифицированная архитектура Testcontainers**: Миграция к единому классу `BaseIntegrationTest`.
- **Упрощенный CI пайплайн**: Удалена зависимость Docker Compose из CI, используются Testcontainers везде.
- **Очистка проекта**: Удалены устаревшие файлы (`Task`, корневой `docker-compose.yml`) из репозитория.
- **Улучшение рабочего процесса Docker**: Добавлена команда `make run-no-cache` для принудительной
  пересборки образов без кэша, что решает проблемы с "застрявшими" файлами.
- **Универсальная система отката (Undo)**: Реализован универсальный хук `useUndoSave` для всех форм сохранения.
  - **Назначение**: Предоставить пользователям 5-секундное окно для отмены операции сохранения.
  - **Применение**: Используется для всех операций создания и редактирования (новости, термины таксономии, и т.д.).
  - **Функциональность**: Сохранение данных формы, возможность отката, восстановление состояния редактирования.
  - **UX**: Snackbar уведомление с кнопкой "UNDO", блокировка интерфейса во время ожидания.

### Пользовательский опыт (UX)
- **Универсальная система отката**: Все формы поддерживают 5-секундное окно для отмены сохранения с возвратом к редактированию.

### Система компоновки главной страницы (HomePageBlock)
  - **Статус реализации**: ✅ **ПОЛНОСТЬЮ РЕАЛИЗОВАНО** (Backend + Frontend Next.js).
  - **Назначение**: Предоставить гибкую настройку структуры главной страницы через систему блоков,
    независимую от фронтенд-реализации (Angular, Next.js или кастомный фронтенд).
  - **Режимы отображения**:
    - **Simple (Стандарт)**: Текущее представление - простой список последних 10 новостей.
    - **Custom (Настраиваемое)**: Блочная компоновка с полной настройкой каждого блока.
    - Переключение режима доступно пользователю в футере сайта.
  - **Параметры блока** (универсальные для всех блоков):
    - **Вес блока** (weight): Определяет порядок отображения (меньше число = выше на странице).
    - **Тип блока**: Переключатель между двумя режимами:
      - **Новостной блок**: Стандартный режим с выбором терминов таксономии и отображением новостей
        - Термины таксономии: Выбор от 1 до всех терминов для фильтрации новостей
        - Количество новостей: Общее число выводимых новостей в блоке
        - Отображение контента: заголовок (обязательно), тизер (опционально)
        - Размер шрифта заголовка: относительно базового размера
      - **Рекламный/Виджет блок**: Режим для размещения рекламы и внешних виджетов
        - Текстовое поле для вставки HTML/JavaScript кода
        - Поддержка рекламных баннеров (изображения)
        - Поддержка текстовых объявлений
        - Поддержка кода Google Ads и других рекламных систем
        - Поддержка виджетов социальных сетей
        - **Безопасность**: Санитизация HTML-кода, фильтрация опасных тегов и скриптов
        - **Ограничения**: Белый список разрешенных доменов для внешних скриптов
  - **Ограничения**: Максимум 50 блоков на главной странице.
  - **Компоненты Backend**:
    - Сущность `HomePageBlock` с универсальными параметрами и типом блока
    - Сущность `HomepageSettings` для хранения режима отображения (Simple/Custom)
    - Сервис санитизации HTML для рекламных блоков
    - Public API: `GET /api/public/homepage` (возвращает структуру в зависимости от режима)
    - Public API: `GET /api/public/homepage/mode` (получить текущий режим)
    - Public API: `PATCH /api/public/homepage/mode` (переключить режим Simple/Custom)
    - Admin API: CRUD операции для управления блоками с валидацией контента
  - **Компоненты Frontend**:
    - UI переключения режима в настройках пользователя
    - Компонент рендеринга новостных блоков для Custom режима
    - Компонент рендеринга рекламных/виджет блоков с безопасной вставкой HTML
    - Компонент простого списка для Simple режима
    - Admin UI для создания и настройки блоков с переключателем типа блока
    - Предварительный просмотр рекламных блоков в админ-панели

---

## Возможные дополнения и направления развития

Этот раздел описывает потенциальные улучшения и архитектурные векторы, которые могут быть рассмотрены
для дальнейшего развития проекта. Идеи сгруппированы по приоритетам для формирования гипотетической
дорожной карты.

### Безопасность (Высокий приоритет)

- **OAuth 2.0 + JWT**: Переход от Basic Auth к системе аутентификации на основе токенов.
  - **Назначение**: Внедрение современного, безопасного и масштабируемого механизма аутентификации.
  - **Компоненты**: Процессы авторизации OAuth 2.0, генерация и валидация JWT, защита эндпоинтов на основе
    токенов, refresh-токены и обновление процедур входа/выхода.

- **Двухфакторная аутентификация (2FA)**: Добавление второго уровня защиты для административных ролей.
  - **Назначение**: Усиление безопасности для учетных записей с повышенными привилегиями (например, ADMIN, EDITOR).
  - **Компоненты**: Генерация и проверка временных одноразовых паролей (TOTP), интеграция с приложениями-
    аутентификаторами, UI/UX для настройки и подтверждения 2FA.

### Функциональность (Средний приоритет)

- **Загрузка файлов**: Реализация поддержки управления изображениями и другими медиафайлами.
  - **Назначение**: Предоставление пользователям возможности загружать файлы напрямую через API.
  - **Компоненты**: Сервис хранения файлов (например, локальное хранилище, S3 или MinIO), API-эндпоинты
    для загрузки и получения файлов.

- **Функциональность поиска**: Разработка системы поиска для публичной и административной частей.
  - **Назначение**: Предоставить пользователям быстрый и эффективный способ поиска контента.
  - **Этап 1 (Angular и Next.js)**: Реализация базового поиска на стороне сервера. Бэкенд предоставит новый
    API-эндпоинт, использующий SQL `LIKE` или `ILIKE` для поиска по заголовкам и содержимому статей.
  - **Этап 2 (Next.js - Перспектива)**: Для фронтенда на Next.js рассмотреть внедрение поиска на стороне
    клиента с помощью **Pagefind**. Этот инструмент создает статический поисковый индекс во время сборки,
    обеспечивая мгновенный поиск без нагрузки на API.

- **Веб-хуки (Webhooks)**: Разработка системы для уведомлений на основе событий.
  - **Назначение**: Уведомление внешних сервисов о конкретных событиях в приложении.
  - **Компоненты**: Механизм для управления подписками на веб-хуки и отправки данных о событиях.

- **Интеграция с Telegram**: Автоматическая публикация анонсов статей в Telegram-канал.
  - **Назначение**: Расширение дистрибуции контента и оперативное информирование подписчиков.
  - **Компоненты**: Telegram Bot клиент, сервис для прослушивания событий создания/публикации статей,
    форматирование сообщений, безопасное хранение токена бота.

### Архитектура и производительность (Низкий приоритет)

- **Переход на реактивный стек**: Рассмотреть миграцию публичных эндпоинтов с высоким трафиком на
  неблокирующий стек (Spring WebFlux и R2DBC) для максимизации масштабируемости.

### Последовательность внедрения

1.  **Завершение бизнес-логики и API**: Завершить и стабилизировать основные функции приложения.
2.  **Внедрение OAuth 2.0 + JWT**: Создание основного механизма аутентификации и авторизации.
3.  **Обновление CI/CD и конфигурации развертывания**: Обеспечение совместимости процесса развертывания с
    новой системой аутентификации.
4.  **Внедрение 2FA**: Добавление двухфакторной аутентификации для административных ролей.

### Поддерживающая инфраструктура и сервисы

- **Email-сервис (например, SMTP, Mailgun)**: Необходим для уведомлений пользователей, подтверждения
  регистрации и восстановления пароля/2FA.
- **Файловое хранилище (например, S3, MinIO)**: Для хранения загружаемого пользователями контента.
- **Мониторинг и логирование (Grafana Cloud)**: Централизованный мониторинг (Prometheus) и агрегация
  логов (Loki), что особенно полезно в продуктивной среде.

### Референсные Frontend-реализации

- **Статус**: Находятся в стадии базовой структуры. Требуется полная реализация компонентов и интеграция
  с API.
- **Next.js Frontend**: Реализован и готов к использованию.
- **Зависимость**: Полноценная работа над фронтендами будет продолжена после окончательной отладки,
  настройки и проверки бэкенда.